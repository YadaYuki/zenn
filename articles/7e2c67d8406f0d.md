---
title: "Goè£½ã®å…¨æ–‡æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³Omochiã‚’ä½œã£ãŸ."
emoji: "ğŸ˜Š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Go","å€‹äººé–‹ç™º","æƒ…å ±æ¤œç´¢"]
published: false
---

# 1.ã¯ã˜ã‚ã«

è†¨å¤§ãªé‡ã®é›»å­ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç›®çš„ã¨ãªã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ãƒ»æŠ½å‡ºã™ã‚‹æƒ…å ±æ¤œç´¢ã€‚ãã®æŠ€è¡“ã¯åºƒãæ™®åŠã—ã€å¤šãã®äººã€…ãŒã€æ§˜ã€…ãªå ´é¢ã§ãã®æ©æµã‚’å—ã‘ã¦ã„ã¾ã™ã€‚[Google](https://google.com/)ã‚„[Bing](https://www.bing.com/)ã‚’ã¯ã˜ã‚ã¨ã—ãŸã€ä¸–ã®ä¸­ã«å¤§ããªã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã‚’ä¸ãˆã‚‹Webæ¤œç´¢ãŒãã®ä»£è¡¨ä¾‹ã§ã™ãŒã€ç‰©ä»¶æ¤œç´¢ã‚„è«–æ–‡æ¤œç´¢ã€ãƒ¡ãƒ¼ãƒ«æ¤œç´¢ãªã©ãã®å¿œç”¨ã¯æ§˜ã€…ã§ã™ã€‚

ã•ã¦ã€ä»Šå›å–ã‚Šçµ„ã‚“ã ã®ã¯ã€Goã«ã‚ˆã‚‹è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç”¨ã„ãŸå…¨æ–‡æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã®ã‚¹ã‚¯ãƒ©ãƒƒãƒå®Ÿè£…ã§ã™ã€‚ç ”ç©¶ã§è‡ªç„¶è¨€èªå‡¦ç†ã‚’å­¦ã‚“ã ã“ã¨ã‚’ãã£ã‹ã‘ã«ã€æƒ…å ±æ¤œç´¢ã‚„è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨ã„ã£ãŸãƒˆãƒ”ãƒƒã‚¯ã«å¼·ã„èˆˆå‘³ãŒæ¹§ã„ãŸã®ã§ã€Elasticsearchç­‰ã«ã¯é ¼ã‚‰ãšã€ã‚¼ãƒ­ã‹ã‚‰å®Ÿè£…ã‚’è¡Œã„ã¾ã—ãŸã€‚ä»¥ä¸‹ã€ãƒªãƒã‚¸ãƒˆãƒªã«ãªã‚Šã¾ã™ã€‚

https://github.com/YadaYuki/omochi/

æœ¬è¨˜äº‹ã§ã¯ã€Omochiã®è¨­è¨ˆãƒ»å®Ÿè£…ã«é–¢ã™ã‚‹èª¬æ˜ã‚’è¡Œãªã£ã¦ã„ãã¾ã™ã€‚

# 2.è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å‹ãƒ»å…¨æ–‡æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³Omochi

ãƒªãƒã‚¸ãƒˆãƒªã®[README.md](https://github.com/YadaYuki/omochi/#readme)ã«ã‚‚è¨˜è¼‰ãŒã‚ã‚Šã¾ã™ãŒã€ä»Šå›å®Ÿè£…ã—ãŸå…¨æ–‡æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³Omochiã¯ä»¥ä¸‹ã®ã‚ˆã†ãªç‰¹å¾´ã‚’æŒã¡ã¾ã™ã€‚

- è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç”¨ã„ãŸå…¨æ–‡æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³.
- RESTful API çµŒç”±ã§ã€äº‹å‰ã«ç™»éŒ²ã—ãŸæ–‡æ›¸ç¾¤ã‚’å¯¾è±¡ã«æ¤œç´¢ãŒå¯èƒ½
- è¤‡æ•°å˜èªã‚’ç”¨ã„ãŸæ¤œç´¢ã¯ã€ANDæ¤œç´¢ãƒ»ORæ¤œç´¢ã«å¯¾å¿œ
- ç™»éŒ²å¯èƒ½ãªè¨€èªï¼šæ—¥æœ¬èª, è‹±èª

ã“ã“ã§ã€å…¨æ–‡æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³Omochiã®å†…éƒ¨æ§‹é€ ã‚’æ¦‚è¦³ã™ã‚‹ãŸã‚ã«ã€æ¦‚è¦å›³ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†.

![Omochiã®æ¦‚è¦³å›³](https://user-images.githubusercontent.com/57289763/179801992-6963b38e-4d3b-44d1-9612-e91c374d194c.png)

æ¦‚è¦å›³ã‹ã‚‰ã‚ã‹ã‚‹é€šã‚Šã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³Omochiã¯

- æ–‡æ›¸ã®ç™»éŒ²(è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆç­‰ã‚‚å«ã‚€)ã‚’è¡Œã†**ã‚¤ãƒ³ãƒ‡ã‚¯ã‚µ(Indexer)**
- æƒ…å ±è¦æ±‚ã«å¯¾ã™ã‚‹æ–‡æ›¸ã®æ¤œç´¢å‡¦ç†ã‚’è¡Œã†**ã‚µãƒ¼ãƒãƒ£ãƒ¼(Searcher)**

ã¨ã„ã†å¤§ããåˆ†ã‘ã¦2ã¤ã®ãƒ‘ãƒ¼ãƒ„ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

æ¬¡ç« ä»¥é™ã§ã¯ã€Omochiã®å…¨ä½“çš„ãªè¨­è¨ˆã«åŠ ãˆã€ãã‚Œãã‚Œã®ãƒ‘ãƒ¼ãƒ„ã«å¯¾ã™ã‚‹å®Ÿè£…ã®è©³ç´°ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†.

# 3 Omochiã®æŠ€è¡“é¸å®š

ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚‚ã‚ã‚‹é€šã‚Šã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³Omochiã¯è¨€èªã¨ã—ã¦ã¯[**Go**](https://go.dev/)ã‚’ç”¨ã„ã¦ã„ã¾ã™ã€‚å€‹äººé–‹ç™ºãªã®ã§ã€ä½¿ã£ã¦ã¿ãŸã‹ã£ãŸã¨ã„ã†èƒŒæ™¯ã‚‚å¤§ãã„ã§ã™ãŒã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã®ã‚ˆã†ã«ã€å½¢æ…‹ç´ è§£æã‚„é–¢é€£æ€§ã®ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ãªã©ã€**å®Ÿè¡Œã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒè¤‡é›‘ã§ã‚ã‚ŠãªãŒã‚‰é€Ÿåº¦ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**ã¨ã€ŒGoã®æŒã¤é«˜é€Ÿæ€§ã€ã¯ãªã‹ãªã‹ç›¸æ€§ãŒè‰¯ã„ã®ã§ã¯ãªã„ã®ã§ã—ã‚‡ã†ã‹ã€‚

ã¾ãŸã€å¾Œã®ç« ã§ã‚‚è§¦ã‚Œã¾ã™ãŒã€**ãƒ‡ãƒ¢ã§ç”¨ã„ã‚‹ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿(æ•°åƒ ~ æ•°ä¸‡ä»¶ç¨‹åº¦ã®æ–‡æ›¸ãƒ‡ãƒ¼ã‚¿)ã‚’æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«ç™»éŒ²ã™ã‚‹å‡¦ç†([seed.go](https://github.com/YadaYuki/omochi/blob/master/cmd/seeds/ja/seed.go))ã§ã¯ã€ã‚´ãƒ«ãƒ¼ãƒãƒ³ã«ã‚ˆã‚‹ä¸¦è¡Œå‡¦ç†ã‚’ç”¨ã„ã¦ã„ã¾ã™**ã€‚ãã®ãŸã‚ã€Goã®ã€Œæ–°ãŸãªã‚¹ãƒ¬ãƒƒãƒ‰(ã‚´ãƒ«ãƒ¼ãƒãƒ³)ã®ä½œæˆã¨ä½œæˆã—ãŸè¤‡æ•°ã®ã‚´ãƒ«ãƒ¼ãƒãƒ³ã®ç®¡ç†ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«è¨˜è¿°ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ç‚¹ã€ã‚‚éå¸¸ã«é­…åŠ›çš„ã§ã‚ã‚‹ã¨æ„Ÿã˜ã¾ã—ãŸã€‚

ãã—ã¦ã€å‘¨è¾ºãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ã¯ä»¥ä¸‹ã‚’ç”¨ã„ã¦ã„ã¾ã™ã€‚

- [net/http](https://pkg.go.dev/net/http) + [chi](https://github.com/go-chi/chi) (Web application server)
- [Docker](https://www.docker.com/)
- [Mariadb](https://mariadb.com/kb/ja/mariadb/)(MySQL)

ãªãŠã€ä»Šå›Omochiã§ã¯ORMã¨ã—ã¦ã€Facebookè£½ã®[ent](https://entgo.io/)ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚entã«ã¯

- goã®ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ã‚¹ã‚­ãƒ¼ãƒ(ãƒ†ãƒ¼ãƒ–ãƒ«)ã®å®šç¾©ãŒå¯èƒ½
- è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹é™çš„å‹ä»˜ã‘ã•ã‚ŒãŸé–¢æ•°ã«ã‚ˆã£ã¦ã€SQLç­‰ã‚’ä¸€åˆ‡æ›¸ã‹ãšã€DBã«å¯¾ã™ã‚‹æ“ä½œãŒã§ãã‚‹

ç­‰ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã€DBã«å¯¾ã™ã‚‹æ“ä½œã‚’ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§è¨˜è¿°ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã€ã¨ã¦ã‚‚ä¾¿åˆ©ã§ã™ã€‚([å…¬å¼Document](https://entgo.io/docs/getting-started#create-your-first-entity)ã‚ˆã‚Š)
```go
func CreateUser(ctx context.Context, client *ent.Client) (*ent.User, error) {
    u, err := client.User.
        Create().
        SetAge(30).
        SetName("a8m").
        Save(ctx)
    ... 
```

ä»¥ä¸ŠãŒOmochiã‚’æ§‹æˆã™ã‚‹æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã®ç´¹ä»‹ã«ãªã‚Šã¾ã™

## 4.ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆæ¦‚è¦³(ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆ)

ã“ã“ã§ã¯ã€Omochiã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­è¨ˆã«é–¢ã™ã‚‹èª¬æ˜ã‚’è¡Œã„ã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å…¨ä½“åƒã‚’æŠŠæ¡ã™ã‚‹ãŸã‚ã«ã€ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆã‚’æ¦‚è¦³ã—ã¦ã¿ã¾ã—ã‚‡ã†

```
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ cmd 
â”‚   â”œâ”€â”€ api/ # ã‚µãƒ¼ãƒèµ·å‹•ã®ãŸã‚ã®ã‚³ãƒ¼ãƒ‰
â”‚   â”‚   â””â”€â”€ main.go
â”‚   â”œâ”€â”€ migrate/
â”‚   â””â”€â”€ seeds/
â”œâ”€â”€ docker
â”‚   â”œâ”€â”€ api/
â”‚   â””â”€â”€ db/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ docs
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ pkg # ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã‚ˆã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…
â”‚   â”œâ”€â”€ common/ # å…¨ä½“å…±é€šã®å‡¦ç†ãƒ»å®šæ•°ç­‰ã®å®šç¾©
â”‚   â”‚   â”œâ”€â”€ constant
â”‚   â”‚   â””â”€â”€ slices
â”‚   â”œâ”€â”€ config/ 
â”‚   â”œâ”€â”€ domain
â”‚   â”‚   â”œâ”€â”€ entities
â”‚   â”‚   â”‚   â”œâ”€â”€ document.go
â”‚   â”‚   â”‚   â”œâ”€â”€ invert_index.go
â”‚   â”‚   â”‚   â”œâ”€â”€ posting.go
â”‚   â”‚   â”‚   â”œâ”€â”€ query.go
â”‚   â”‚   â”‚   â””â”€â”€ term.go
â”‚   â”‚   â”œâ”€â”€ repository
â”‚   â”‚   â”‚   â”œâ”€â”€ document_repository.go
â”‚   â”‚   â”‚   â””â”€â”€ term_repository.go
â”‚   â”‚   â””â”€â”€ service
â”‚   â”‚       â”œâ”€â”€ document_ranker.go
â”‚   â”‚       â”œâ”€â”€ indexer.go
â”‚   â”‚       â”œâ”€â”€ invert_index_compresser.go
â”‚   â”‚       â”œâ”€â”€ searcher.go
â”‚   â”‚       â””â”€â”€ tokenizer.go
â”‚   â”œâ”€â”€ ent/ # go(ent)ã«ã‚ˆã‚‹DBã®ã‚¹ã‚­ãƒ¼ãƒã®å®šç¾©ãƒ»entã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰
â”‚   â”œâ”€â”€ errors/ 
â”‚   â”œâ”€â”€ infrastructure
â”‚   â”‚   â”œâ”€â”€ compresser
â”‚   â”‚   â”‚   â”œâ”€â”€ zlib_invert_index_compresser.go
â”‚   â”‚   â”‚   â””â”€â”€ zlib_invert_index_compresser_test.go
â”‚   â”‚   â”œâ”€â”€ documentranker
â”‚   â”‚   â”‚   â””â”€â”€ tfidfranker
â”‚   â”‚   â”œâ”€â”€ indexer
â”‚   â”‚   â”‚   â”œâ”€â”€ indexer.go
â”‚   â”‚   â”‚   â””â”€â”€ indexer_test.go
â”‚   â”‚   â”œâ”€â”€ persistence
â”‚   â”‚   â”œâ”€â”€ searcher
â”‚   â”‚   â”‚   â”œâ”€â”€ searcher.go
â”‚   â”‚   â”‚   â””â”€â”€ searcher_test.go
â”‚   â”‚   â”œâ”€â”€ tokenizer
â”‚   â”‚   â”‚   â”œâ”€â”€ eng
â”‚   â”‚   â”‚   â””â”€â”€ ja
â”‚   â”‚   ...
â”‚   â”œâ”€â”€ interface/ 
â”‚   â””â”€â”€ usecase/ 
â””â”€â”€ scripts
...
```

ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆã‹ã‚‰ã‚ã‹ã‚‹é€šã‚Šã€ä»Šå›ã¯ä»¥ä¸‹ã®4ã¤ã®ãƒ¬ã‚¤ãƒ¤ã‚’æŒã¤ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚

- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å±¤(pkg/interface)
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ (pkg/usecase)
- ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤(pkg/domain)
- ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤(pkg/infrastructure)

è¦³æ¸¬ã—ãŸé™ã‚Šã€Goã«ã‚ˆã‚‹OSSã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ã‚‚ã®ã¯å°‘ãªã„ã‚ˆã†ã«æ„Ÿã˜ã‚‰ã‚Œã¾ã™ã€‚ãã‚“ãªä¸­ã€Omochiã§ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ãŸç†ç”±ã¨ã—ã¦ã¯ã€**å„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¤–å´ã‹ã‚‰ãƒ¬ã‚¤ãƒ¤ãƒ¼å†…éƒ¨ã®å®Ÿè£…ãŒè¦‹ãˆãªã„ã‚ˆã†ã«æŠ½è±¡åŒ–ã‚’æ–½ã™ã“ã¨ã«ã‚ˆã£ã¦ã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã‚’æ§‹æˆã™ã‚‹å…·ä½“çš„ãªæŠ€è¡“ã‚’å‰¥ãŒã—ã‚„ã™ãã—ãŸã‹ã£ãŸã“ã¨**ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚

ã“ã“ã§ã„ã†æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã‚’æ§‹æˆã™ã‚‹å…·ä½“çš„ãªæŠ€è¡“ã¨ã¯ã€ä¾‹ãˆã°ä»¥ä¸‹ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚

- å½¢æ…‹ç´ è§£æãƒ»åˆ†ã‹ã¡æ›¸ãã®ãƒ„ãƒ¼ãƒ«ãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒª(kagome,prose,nltk)
- è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ»æ–‡æ›¸ã‚’æ°¸ç¶šåŒ–ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«(RDB,NoSQL)
- ãƒ‡ãƒ¼ã‚¿æ“ä½œã®ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª(ent,gorm)
- ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ (TfIdf,BM25)

ä»¥ä¸Šã®èƒŒæ™¯ã‹ã‚‰ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­è¨ˆã¨ã—ã¦ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ã€å®Ÿè£…ã‚’è¡Œã„ã¾ã—ãŸã€‚

# 5.ã‚¤ãƒ³ãƒ‡ã‚¯ã‚µã®å®Ÿè£…(Indexer)

æœ¬ç« ã§ã¯ã€æ¤œç´¢å¯¾è±¡ã¨ãªã‚‹æ–‡æ›¸(Document)ã®æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã¸ã®ç™»éŒ²ã‚’è¡Œã†ã‚¤ãƒ³ãƒ‡ã‚¯ã‚µã®Goã«ã‚ˆã‚‹å®Ÿè£…ã‚’ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚Omochiã«ãŠã‘ã‚‹ã‚¤ãƒ³ãƒ‡ã‚¯ã‚µã¯[Indexer](https://github.com/YadaYuki/omochi/blob/add-license-1/pkg/infrastructure/indexer/indexer.go#L13-L18)ã¨ã„ã†Goã®æ§‹é€ ä½“ã§å®Ÿè£…ã•ã‚Œã¦ãŠã‚Šã€[Indexer.IndexingDocument](https://github.com/YadaYuki/omochi/blob/add-license-1/pkg/infrastructure/indexer/indexer.go#L24)é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦ã€æ–‡æ›¸ã®ç™»éŒ²ãŒå¯èƒ½ã§ã™ã€‚

æ–‡æ›¸ã®ç™»éŒ²ã‚’å®Ÿè¡Œã™ã‚‹Indexer.IndexingDocumenté–¢æ•°ã§ã¯ã€ç™»éŒ²ã•ã‚Œã‚‹æ–‡æ›¸ã§ã‚ã‚‹[DocumentCreate](https://github.com/YadaYuki/omochi/blob/add-license-1/pkg/domain/entities/document.go#L15-L18)ã¨ã„ã†å‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¼•æ•°ã¨ã—ã¦

- æ–‡æ›¸ã‚’å˜èª(ã‚¿ãƒ¼ãƒ )ã«åˆ†å‰²ã—ã€ç´¢å¼•å¯¾è±¡ã¨ãªã‚‹å˜èªã‚’æŠ½å‡ºã™ã‚‹
- æ–‡æ›¸(ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)ã®æ–°è¦ä½œæˆ(æ°¸ç¶šåŒ–)
- è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆ
- ä½œæˆã—ãŸè»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’åœ§ç¸®ã™ã‚‹
- è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ–°è¦ç™»éŒ² ã‚‚ã—ãã¯ æ›´æ–°(æ°¸ç¶šåŒ–)

ã¨ã„ã†5ã¤ã®å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

## 5.1 è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨ã¯ï¼Ÿ

ã•ã¦ã€IndexingDocumentã®å…·ä½“çš„ãªå®Ÿè£…ã‚’è¦‹ã¦ã„ãå‰ã«Omochi(ã¨å¤šãã®æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³)ã‚’æ”¯ãˆã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§ã‚ã‚‹è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«é–¢ã™ã‚‹èª¬æ˜ã‚’ã—ã¦ã„ãã¾ã™ã€‚

è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ã€æ–‡æ›¸ç¾¤å†…ã«ç™»å ´ã™ã‚‹ã€Œå˜èª$w$ã€ã¨ã€Œå˜èªwãŒç™»å ´ã™ã‚‹æ–‡æ›¸iã«é–¢ã™ã‚‹æƒ…å ±$D_i$(æ–‡æ›¸idã€æ–‡æ›¸å†…ã§$w$ãŒç™»å ´ã™ã‚‹ä½ç½®ã‚„å›æ•°..etc)ã€ã‚’ç´ä»˜ã‘ãŸä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æŒ‡ã—ã¾ã™ã€‚

$$ \{w_1: [D_1,D_2...],w_2: [D_2,D_5...],... \} $$

ã“ã“ã§ã¯ã€æ–‡æ›¸éƒ¡å†…ã«ç™»å ´ã—ã€ç´¢å¼•å¯¾è±¡ã¨ãªã‚‹å˜èª$w$ã‚’**ã‚¿ãƒ¼ãƒ **ã€ã‚¿ãƒ¼ãƒ ã«ç´ã¥ã„ãŸæ–‡æ›¸æƒ…å ±ã®é…åˆ—($[D_i,...]$)ã‚’**ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆ**ã¨å‘¼ã³ã¾ã™ã€‚

ãã‚Œã§ã¯ä¾‹ã¨ã—ã¦ã€ä»¥ä¸‹ã®3ã¤ã®æ–‡æ›¸(æ˜ ç”»ã‚¿ã‚¤ãƒˆãƒ«)ãŒæ¤œç´¢å¯¾è±¡ã¨ãªã‚‹ã‚ˆã†ãªæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã‚’æƒ³å®šã—ã¦ã€è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

1. **"Toy Story"**
2. **"The Wolf of Wall Street"**
3. **"The NeverEnding Story"**

ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆã®å„ã‚¢ã‚¤ãƒ†ãƒ ã«ã¯ã€ã€Œæ–‡æ›¸idã€ã¨ã€Œå„æ–‡æ›¸ã«ãŠã‘ã‚‹å˜èªã®ç™»å ´ä½ç½®ã€ã‚’æ ¼ç´ã™ã‚‹ã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªè»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

```JS
{
    "NeverEnding":[
        {"document_id": 3, "positions_in_document": [1]} // æ–‡æ›¸id=3ã®æ–‡æ›¸("The NeverEnding Story")ã®1å˜èªç›®(0ã‹ã‚‰æ•°ãˆã‚‹)ã«ç™»å ´
    ],
    "Story":[
        {"document_id": 1, "positions_in_document": [1]},
        {"document_id": 3, "positions_in_document": [1]}, 
    ],
    "Street":[
        {"document_id": 2, "positions_in_document": [4]}
    ],
    "The":[
        {"document_id": 2, "positions_in_document": [0]}
        {"document_id": 3, "positions_in_document": [0]}
    ]
    ...
}
```

å¤šãã®æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã§ã¯ã€ã“ã®ã‚ˆã†ã«ã€**è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨ã„ã†éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã§ã‚ã‹ã‚Šã‚„ã™ã„ãƒ‡ãƒ¼ã‚¿æ§‹é€ **ã‚’äº‹å‰ã«ä½œæˆãƒ»ä¿å­˜ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ãŒè¦æ±‚ã™ã‚‹å˜èªã®å«ã¾ã‚Œã‚‹æ–‡æ›¸ç¾¤ã¸ã®é«˜é€Ÿãªã‚¢ã‚¯ã‚»ã‚¹ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

## 5.2 Indexerãƒ»IndexingDocumenté–¢æ•°

è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ã¤ã„ã¦ç†è§£ãŒæ·±ã¾ã£ãŸã¨ã“ã‚ã§ã€ã‚¤ãƒ³ãƒ‡ã‚¯ã‚µã®å®Ÿè£…ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚å®Ÿè£…ã‚’ã¿ã¦ã„ãå‰ã«

- æ–‡æ›¸ã‚’ã‚¿ãƒ¼ãƒ ã«åˆ†å‰²ã™ã‚‹æ‰‹æ³•
- è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®åœ§ç¸®æ‰‹æ³•
- è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ»æ–‡æ›¸ã®æ°¸ç¶šåŒ–

ã¨ã„ã†3ç‚¹ã«ã¤ã„ã¦è£œè¶³ã§èª¬æ˜ã‚’è¡Œã„ã¾ã™

### **æ–‡æ›¸ã‚’ã‚¿ãƒ¼ãƒ ã«åˆ†å‰²ã™ã‚‹æ‰‹æ³•**

è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã™ã‚‹éš›ã«é‡è¦ã¨ãªã‚‹**æ–‡æ›¸ã‚’ã‚¿ãƒ¼ãƒ (å˜èª)ã«åˆ†å‰²ã—ã€ç´¢å¼•å¯¾è±¡ã¨ãªã‚‹å˜èªã‚’æŠ½å‡ºã™ã‚‹**æ‰‹æ³•ã«ã¯ã€

- n-gram
- [Mecab](https://taku910.github.io/mecab/)ç­‰ã®ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’ç”¨ã„ãŸåˆ†ã‹ã¡æ›¸ã

ãªã©æ§˜ã€…ãªæ‰‹æ³•ãŒå­˜åœ¨ã—ã¾ã™ã€‚ãã®ä¸­ã§ã‚‚ã€Omochiã¯ã€æ—¥æœ¬èªãƒ»è‹±èªã®ãã‚Œãã‚Œã«å¯¾ã—ã¦ã€Goã§åˆ†ã‹ã¡æ›¸ãã‚„å½¢æ…‹ç´ è§£æã‚’å®¹æ˜“ã«å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã‚‹

- æ—¥æœ¬èª: [Kagome](https://github.com/ikawaha/kagome)ã«ã‚ˆã‚‹åˆ†ã‹ã¡æ›¸ããƒ»å½¢æ…‹ç´ è§£æ
- è‹±èª: [Prose](https://github.com/jdkato/prose)ã«ã‚ˆã‚‹å˜èªã¸ã®åˆ†å‰²ãƒ»å½¢æ…‹ç´ è§£æ

ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã‚’æ´»ç”¨ã—ã€æ–‡æ›¸ã®å˜èªã¸ã®åˆ†å‰²ãŠã‚ˆã³ç´¢å¼•å¯¾è±¡ã¨ãªã‚‹å˜èªã‚’æŠ½å‡ºã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

### **è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®åœ§ç¸®æ‰‹æ³•**

æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«ç™»éŒ²ã•ã‚Œã‚‹æ–‡æ›¸ã®ãƒ‡ãƒ¼ã‚¿é‡ãŒå¢—ãˆã‚‹ã¨ã€è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚µã‚¤ã‚ºãŒéå¸¸ã«å¤§ãããªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€Omochiã‚’å«ã‚€ã€å¤šãã®æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã§ã¯**è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’åœ§ç¸®ã—ã¦æ°¸ç¶šåŒ–ã—ã¦ã„ã¾ã™ã€‚**

Omochiã§ã¯ã€**è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å«ã¾ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®å¤§éƒ¨åˆ†ã‚’å ã‚ã‚‹ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆã‚’åœ§ç¸®ã™ã‚‹**ã“ã¨ã§ã€ä¿å­˜æ™‚ã«ãŠã‘ã‚‹è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒ‡ãƒ¼ã‚¿é‡ã‚’å‰Šæ¸›ã—ã¦ã„ã¾ã™ã€‚

ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆã®åœ§ç¸®ã¯ä»¥ä¸‹ã®2ã¤ã®æ‰‹é †ã§å®Ÿè¡Œã•ã‚Œã¾ã™

1. **ãƒã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒªã‚¹ãƒˆã‚’æ ¼ç´ã™ã‚‹é…åˆ—ã‚’[gob](https://pkg.go.dev/encoding/gob)ã«ã‚ˆã‚Šã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºåŒ–(ãƒã‚¤ãƒˆå‹ã®é…åˆ—ã«å¤‰æ›)**
2. **ã€Œ1ã€ã«ã‚ˆã‚Šå¾—ã‚‰ã‚ŒãŸãƒã‚¤ãƒˆå‹ã®é…åˆ—ã‚’[zlib](https://pkg.go.dev/compress/zlib)ã«ã‚ˆã£ã¦åœ§ç¸®ã€‚**

ãªãŠã€2ã¤ã®æ‰‹é †ã¯ã€ã„ãšã‚Œã‚‚goã®æ¨™æº–ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿ã§å®Ÿè£…ãŒå¯èƒ½ã§ã™ã€‚

### **è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹(åœ§ç¸®æ¸ˆã¿)ãƒ»æ–‡æ›¸ã®æ°¸ç¶šåŒ–**

ã™ã§ã«è¿°ã¹ãŸé€šã‚Šã€æ°¸ç¶šåŒ–ã®ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã¨ORMã«ã¯ãã‚Œãã‚ŒMySQLã¨entã‚’ç”¨ã„ã¦ã„ã¾ã™ã€‚

ã—ã‹ã—ã€Indexerãƒ»IndexingDocumenté–¢æ•°ã¯ã€**ã€Œå…·ä½“ã§ã¯ãªãæŠ½è±¡ã«ä¾å­˜ã™ã‚‹ã€ã¨ã„ã†DIPã®ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã‚‹ã¹ãã€domainãƒ¬ã‚¤ãƒ¤ã§å®šç¾©ã•ã‚ŒãŸæŠ½è±¡([DocumentRepository](https://github.com/YadaYuki/omochi/blob/534ce5cbe66e9bfce60ba8ee6ffad8d990543800/pkg/domain/repository/document_repository.go#L10)ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹)ã«ä¾å­˜ã™ã‚‹ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™**ã€‚

ãã®ãŸã‚ã€MySQLã‚„entã¨ã„ã£ãŸãƒ„ãƒ¼ãƒ«ç¾¤ã®çŸ¥è­˜ã¯Indexerã®å®Ÿè£…ã«å«ã‚“ã§ã„ã¾ã›ã‚“ã€‚[Indexerã‚’åˆæœŸåŒ–](https://github.com/YadaYuki/omochi/blob/534ce5cbe66e9bfce60ba8ee6ffad8d990543800/cmd/seeds/ja/seed.go#L48)ã™ã‚‹éš›ã«ã€MySQLã¨æ¥ç¶šã™ã‚‹Entã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’é–¢æ•°ã®å¼•æ•°ã¨ã—ã¦ä¸ãˆã¦ã„ã¾ã™(Dependency Injection)

ä»¥ä¸Šã®3ç‚¹ã‚’è¸ã¾ãˆã¦ã€IndexerãŠã‚ˆã³IndexingDocumenté–¢æ•°ã®å®Ÿè£…ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```go
package indexer

import (
	"context"

	"github.com/YadaYuki/omochi/pkg/domain/entities"
	"github.com/YadaYuki/omochi/pkg/domain/repository"
	"github.com/YadaYuki/omochi/pkg/domain/service"
	"github.com/YadaYuki/omochi/pkg/errors"
	"github.com/YadaYuki/omochi/pkg/errors/code"
)

type Indexer struct {
	documentRepository    repository.DocumentRepository
	termRepository        repository.TermRepository
	tokenizer             service.Tokenizer
	invertIndexCompresser service.InvertIndexCompresser
}

func NewIndexer(documentRepository repository.DocumentRepository, termRepository repository.TermRepository, tokenizer service.Tokenizer, invertIndexCompresser service.InvertIndexCompresser) service.Indexer {
	return &Indexer{documentRepository, termRepository, tokenizer, invertIndexCompresser}
}

func (indexer *Indexer) IndexingDocument(ctx context.Context, document *entities.DocumentCreate) *errors.Error {

	// æ–‡æ›¸ã‚’å˜èªã«åˆ†å‰²ã—ã€ç´¢å¼•å¯¾è±¡ã¨ãªã‚‹å˜èªã‚’æŠ½å‡ºã™ã‚‹
	tokenizedContent, tokenizeErr := indexer.tokenizer.Tokenize(ctx, document.Content)
	if tokenizeErr != nil {
		return errors.NewError(tokenizeErr.Code, tokenizeErr.Error())
	}

        // æ–‡æ›¸(ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ)ã®æ–°è¦ä½œæˆ(æ°¸ç¶šåŒ–)
	document.TokenizedContent = make([]string, len(*tokenizedContent))
	for i, term := range *tokenizedContent {
		document.TokenizedContent[i] = term.Word
	}
    
	documentDetail, documentCreateErr := indexer.documentRepository.CreateDocument(ctx, document)
	if documentCreateErr != nil {
		return errors.NewError(documentCreateErr.Code, documentCreateErr.Error())
	}

        // è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä½œæˆ
	wordToPostingMap := make(map[string]*entities.Posting)
	for position, word := range document.TokenizedContent {
		if _, ok := wordToPostingMap[word]; ok {
			wordToPostingMap[word].PositionsInDocument = append(wordToPostingMap[word].PositionsInDocument, position)
		} else {
			positionsInDocument := []int{position}
			wordToPostingMap[word] = entities.NewPosting(documentDetail.Id, positionsInDocument)
		}
	}

	termCompresseds, termErr := indexer.termRepository.FindTermCompressedsByWords(ctx, &document.TokenizedContent)
	if termErr != nil {
		return errors.NewError(documentCreateErr.Code, termErr.Error())
	}
	terms := make([]entities.TermCreate, len(*termCompresseds))
	wordToTermsMap := make(map[string]*entities.TermCreate)
	for i, termCompressed := range *termCompresseds {
		invertIndex, decompressErr := indexer.invertIndexCompresser.Decompress(ctx, termCompressed.InvertIndexCompressed)
		if decompressErr != nil {
			panic(decompressErr)
		}
		terms[i].Word = termCompressed.Word
		terms[i].InvertIndex = invertIndex
		wordToTermsMap[termCompressed.Word] = &terms[i]
	}

	for wordInDocument, posting := range wordToPostingMap {
		if _, ok := wordToTermsMap[wordInDocument]; ok {
			*wordToTermsMap[wordInDocument].InvertIndex.PostingList = append(*wordToTermsMap[wordInDocument].InvertIndex.PostingList, *posting)
		} else {
			invertIndex := entities.NewInvertIndex(&[]entities.Posting{*posting})
			wordToTermsMap[wordInDocument] = entities.NewTermCreate(wordInDocument, invertIndex)
		}
	}

	upsertTermCompresseds := &[]entities.TermCompressedCreate{}
	for wordInDocument := range wordToTermsMap {
		invertIndexCompressed, compressErr := indexer.invertIndexCompresser.Compress(ctx, wordToTermsMap[wordInDocument].InvertIndex) // è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®åœ§ç¸®
		if compressErr != nil { 
			panic(compressErr)
		}
		termCompressed := entities.NewTermCompressedCreate(wordInDocument, invertIndexCompressed)
		*upsertTermCompresseds = append(*upsertTermCompresseds, *termCompressed)
	}

	// è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ–°è¦ç™»éŒ² ã‚‚ã—ãã¯ æ›´æ–°(æ°¸ç¶šåŒ–)
	upsertErr := indexer.termRepository.BulkUpsertTerm(ctx, upsertTermCompresseds)
	if upsertErr != nil {
		return errors.NewError(code.Unknown, upsertErr)
	}

	return nil
}
```

ä»¥ä¸ŠãŒã‚¤ãƒ³ãƒ‡ã‚¯ã‚µã®å®Ÿè£…(Indexer)ã®èª¬æ˜ã«ãªã‚Šã¾ã™ã€‚

# 6.ã‚µãƒ¼ãƒãƒ£ã®å®Ÿè£…(Searcher)

æ¬¡ã«**ãƒ¦ãƒ¼ã‚¶ã‹ã‚‰ã®æƒ…å ±è¦æ±‚(æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰)ã‹ã‚‰è©²å½“ã™ã‚‹æ–‡æ›¸ã‚’é–¢é€£åº¦ãŒé«˜ã„æ–¹ã‹ã‚‰é™é †ã«ã‚½ãƒ¼ãƒˆã—ã¦å–å¾—ã™ã‚‹ã€ã™ãªã‚ã¡ã€å…¨æ–‡æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã®è‚ã§ã‚ã‚‹æ¤œç´¢æ©Ÿèƒ½ãŒå®Ÿè£…ã•ã‚ŒãŸã‚µãƒ¼ãƒãƒ£**ã«é–¢ã™ã‚‹èª¬æ˜ã§ã™ã€‚ã‚µãƒ¼ãƒãƒ£ã¯Searcherã¨ã„ã†Goã®æ§‹é€ ä½“ã§å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚Searcher.Searché–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦æ¤œç´¢ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

Searcher.Searchã¯ä»¥ä¸‹ã®ã‚ˆã†ãªQueryå‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¼•æ•°ã¨ã—ã¦å—ã‘å–ã‚Šã¾ã™ã€‚
```go
type SearchModeType string

const (
	And SearchModeType = "And"
	Or  SearchModeType = "Or"
)

type Query struct {
	Keywords   *[]string      `json:"keywords"`
	SearchMode SearchModeType `json:"mode"` // And,Or
}
```

ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã‚ã‚‹`SearchMode`ã«ã¯`And`ã‚‚ã—ãã¯`Or`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Š`keywords`é…åˆ—å†…ã®å˜èªã‚’å…¨ã¦å«ã‚€æ–‡æ›¸ã‚’æ¤œç´¢ã™ã‚‹ã‹(Andæ¤œç´¢)ã€å°‘ãªãã¨ã‚‚`keywords`é…åˆ—å†…ã®å˜èªã®ã„ãšã‚Œã‹ä¸€ã¤ã‚’å«ã‚€æ–‡æ›¸ã‚’æ¤œç´¢ã™ã‚‹ã‹(Oræ¤œç´¢)ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã„ã¾ã™ã€‚

Searcher.Searché–¢æ•°å†…ã§ã¯ã€

- åœ§ç¸®æ¸ˆã¿è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹(InvertIndexCompressed)ã®å–å¾—
- è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è§£å‡
- è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹æ–‡æ›¸IDã«è©²å½“ã™ã‚‹æ–‡æ›¸ç¾¤ã®ãƒ‡ãƒ¼ã‚¿å–å¾—
- å–å¾—ã—ãŸæ–‡æ›¸ç¾¤ã®é–¢é€£åº¦ã«å¿œã˜ãŸä¸¦ã³æ›¿ãˆ(æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ãŒ1èªã§ã‚ã£ãŸå ´åˆã®ã¿)

ã¨ã„ã†4ã¤ã®å‡¦ç†ã‚’å†…éƒ¨çš„ã«å®Ÿè£…è¡Œã£ã¦ã„ã¾ã™ã€‚

Searcher.Searché–¢æ•°ã®å†…éƒ¨å‡¦ç†ãŒæ¦‚è¦³ã§ããŸã¨ã“ã‚ã§ã€

- ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªè»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- æ–‡æ›¸ã®ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°

ã¨ã„ã†2ç‚¹ã«ã¤ã„ã¦è£œè¶³èª¬æ˜ã‚’è¡Œãªã£ã¦ã„ãã¾ã™ã€‚

### ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªè»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã§ã¯ã€æ¤œç´¢å‡¦ç†ã®é«˜é€ŸåŒ–ã®ãŸã‚ã®å·¥å¤«ã¨ã—ã¦ã€ã€Œæ–‡æ›¸å†…ã§é »å‡ºã™ã‚‹ã‚¿ãƒ¼ãƒ ã€ã‚„ã€Œã‚ˆãæ¤œç´¢ã•ã‚Œã‚‹ã‚¿ãƒ¼ãƒ ã€ã‚’ä¸­å¿ƒã«è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä¸€éƒ¨ã‚’ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸(RDBç­‰)ã§ã¯ãªãã€ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ãŠãã“ã¨ãŒä¸€èˆ¬çš„ã§ã™ã€‚

Omochiã§ã¯ã€Searcheræ§‹é€ ä½“ã«`invertIndexCached`ã¨ã„ã†mapå‹(key:ã‚¿ãƒ¼ãƒ (å˜èª),value:è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹)ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç”¨æ„ã™ã‚‹ã“ã¨ã§ãã‚Œã‚’å®Ÿç¾ã—ã¾ã—ãŸã€‚

```go
package searcher

...

type Searcher struct {
	invertIndexCached  map[string]*entities.InvertIndex // è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ä¸€éƒ¨ã‚’ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã§æ ¼ç´ã™ã‚‹ãŸã‚ã®è¾æ›¸å‹å¤‰æ•°
	...
}
```

`Searcher.Search`é–¢æ•°ã§ã¯ã€æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã«è©²å½“ã™ã‚‹è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ã™ã‚‹éš›ã€ã„ããªã‚Šã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã¯å•ã„åˆã‚ã›ãšã€ã¾ãšã€`invertIndexCached`å†…ã«ã€è©²å½“ã™ã‚‹è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå­˜åœ¨ã—ãªã„ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã™ã€‚

### æ–‡æ›¸ã®ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°

Googleã‚’ã¯ã˜ã‚ã¨ã™ã‚‹æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã§ã¯ã€ç‹¬è‡ªã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«ã‚ˆã‚Šã€æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã«å¯¾ã™ã‚‹æ–‡æ›¸ã®é–¢é€£åº¦ã‚’ç®—å‡ºã—ã€é–¢é€£åº¦ãŒé«˜ã„ã‚‚ã®ã‹ã‚‰é †ç•ªã«æ¤œç´¢çµæœã‚’æç¤ºã—ã¦ã„ã¾ã™ã€‚

ç¾æ™‚ç‚¹ã®ã€Omochiã¯æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ãŒ1èªã§ã‚ã£ãŸå ´åˆã®ã¿ã€é–¢é€£åº¦ã«å¿œã˜ã¦æ¤œç´¢çµæœã¨ãªã‚‹æ–‡æ›¸ãŒä¸¦ã³æ›¿ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚é–¢é€£åº¦ã®ç®—å‡ºã«ã¯ã€TF-IDFã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚

$$TF_i(t) = freq(t,d_i)$$
$$IDF(t) = log((1+n)/(1+df_t))$$
$$TF\verb|-|IDF_i(t) = TF_i(t) * (IDF(t) + 1)$$

TF-IDFã«ã‚ˆã‚‹æ–‡æ›¸ã®ä¸¦ã³æ›¿ãˆã¯ã€[TfIdfDocumentRanker](https://github.com/YadaYuki/omochi/blob/yadayuki/add-readme/pkg/infrastructure/documentranker/tfidfranker/tf_idf_document_ranker.go#L14)ã¨ã„ã†æ§‹é€ ä½“ã§å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚é•·ããªã‚‹ãŸã‚ã“ã“ã«ã¯æ²è¼‰ã—ã¾ã›ã‚“ãŒã€èˆˆå‘³ãŒã‚ã‚‹æ–¹ã¯ãœã²è¦‹ã¦ã¿ã¦ãã ã•ã„ã€‚

ä»¥ä¸Šã®2ç‚¹ã‚’è¸ã¾ãˆã¦ã€Searcherã®å®Ÿè£…ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```go
package searcher

import (
	"context"
	"fmt"
	"log"

	"github.com/YadaYuki/omochi/pkg/domain/entities"
	"github.com/YadaYuki/omochi/pkg/domain/repository"
	"github.com/YadaYuki/omochi/pkg/domain/service"
	"github.com/YadaYuki/omochi/pkg/errors"
	"github.com/YadaYuki/omochi/pkg/errors/code"
)

type Searcher struct {
	invertIndexCached  map[string]*entities.InvertIndex
	termRepository     repository.TermRepository
	documentRepository repository.DocumentRepository
	compresser         service.InvertIndexCompresser
	documentRanker     service.DocumentRanker
}

func NewSearcher(invertIndexCached map[string]*entities.InvertIndex, termRepository repository.TermRepository, documentRepository repository.DocumentRepository, compresser service.InvertIndexCompresser, documentRanker service.DocumentRanker) service.Searcher {
	return &Searcher{invertIndexCached, termRepository, documentRepository, compresser, documentRanker}
}

func (s *Searcher) Search(ctx context.Context, query *entities.Query) ([]*entities.Document, *errors.Error) {

	if len(*query.Keywords) == 1 {
		return s.searchBySingleKeyword(ctx, query)
	}
	switch query.SearchMode { // SearchModeã«ã‚ˆã‚‹æ¡ä»¶åˆ†å²
	case entities.Or:
		return s.searchOr(ctx, query)

	case entities.And:
		return s.searchAnd(ctx, query)

	default:
		return nil, errors.NewError(code.Unknown, fmt.Sprintf("unsupported search mode: %s", query.SearchMode))
	}
}

func (s *Searcher) searchBySingleKeyword(ctx context.Context, query *entities.Query) ([]*entities.Document, *errors.Error) {
	invertIndex, ok := s.invertIndexCached[(*query.Keywords)[0]] // ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã®è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
	if !ok {
		termCompressed, err := s.termRepository.FindTermCompressedByWord(ctx, (*query.Keywords)[0]) // åœ§ç¸®æ¸ˆã¿è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹(InvertIndexCompressed)ã®å–å¾—
		if err != nil {
			return nil, errors.NewError(err.Code, err)
		}
		invertIndexCompressed := termCompressed.InvertIndexCompressed
		invertIndex, err = s.compresser.Decompress(ctx, invertIndexCompressed) // è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è§£å‡
		if err != nil {
			return nil, errors.NewError(err.Code, err)
		}
	}

	documentIds := []int64{}
	for _, postingList := range *invertIndex.PostingList {
		documentIds = append(documentIds, postingList.DocumentRelatedId)
	}

	documents, documentErr := s.documentRepository.FindDocumentsByIds(ctx, &documentIds) // è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹æ–‡æ›¸IDã«è©²å½“ã™ã‚‹æ–‡æ›¸ç¾¤ã®ãƒ‡ãƒ¼ã‚¿å–å¾—
	if documentErr != nil {
		return nil, errors.NewError(documentErr.Code, documentErr)
	}
	sortedDocument, sortErr := s.documentRanker.SortDocumentByScore(ctx, (*query.Keywords)[0], documents) // å–å¾—ã—ãŸæ–‡æ›¸ç¾¤ã®é–¢é€£åº¦ã«å¿œã˜ãŸä¸¦ã³æ›¿ãˆ
	if sortErr != nil {
		return nil, errors.NewError(sortErr.Code, sortErr)
	}
	return sortedDocument, nil
}

func (s *Searcher) searchOr(ctx context.Context, query *entities.Query) ([]*entities.Document, *errors.Error) {
	...{ORæ¤œç´¢ã®å®Ÿè£…}
}

func (s *Searcher) searchAnd(ctx context.Context, query *entities.Query) ([]*entities.Document, *errors.Error) {
	....{ANDæ¤œç´¢ã®å®Ÿè£…}
}
```

ä»¥ä¸ŠãŒã‚µãƒ¼ãƒãƒ£ã®å®Ÿè£…(Searcher)ã®èª¬æ˜ã«ãªã‚Šã¾ã™ã€‚

# 7.å‹•ä½œç¢ºèªãƒ»ãƒ‡ãƒ¢

## 7.1 äº‹å‰æº–å‚™

æœ¬ç« ã§ã¯ã€æ•°åƒä»¶ã€œæ•°ä¸‡ä»¶ç¨‹åº¦ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”¨ã„ã¦ã€å®Ÿéš›ã«Omochiã«ã‚ˆã‚‹å…¨æ–‡æ¤œç´¢ã‚’è©¦ã—ã¦ã„ãã¾ã™ã€‚ãƒªãƒã‚¸ãƒˆãƒªå†…ã«ã¯ã€OmochiãŒå¯¾å¿œã™ã‚‹è¨€èªã§ã‚ã‚‹æ—¥æœ¬èªã¨è‹±èªã®ãã‚Œãã‚Œã«å¯¾ã—ã¦ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„ã—ã¾ã—ãŸã€‚

æ—¥æœ¬èªã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ã¯ã€æœ¬è¨˜äº‹ã®ç­†è€…ãŒæœ€ã‚‚æ„›ã™ã‚‹æ¼«ç”»ã®ä¸€ã¤ã§ã‚ã‚‹ã€Œ[ãƒ‰ãƒ©ãˆã‚‚ã‚“](https://dora-world.com/)ã€ã®ã‚³ãƒŸãƒƒã‚¯ã‚¿ã‚¤ãƒˆãƒ«(1,316ä»¶)ã‚’ä½¿ç”¨ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚(è‹±èªã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã«ã¯[45,466ä»¶ã®æ˜ ç”»ã‚¿ã‚¤ãƒˆãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ](https://www.kaggle.com/datasets/rounakbanik/the-movies-dataset)ã‚’ä½¿ç”¨ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚)

æ¤œç´¢ã‚’å®Ÿè¡Œã—ã¦ã„ãå‰ã«äº‹å‰æº–å‚™ã¨ã—ã¦ã€TSVãƒ•ã‚¡ã‚¤ãƒ«ã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹æ–‡æ›¸ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿(ãƒ‰ãƒ©ãˆã‚‚ã‚“ã®ã‚³ãƒŸãƒƒã‚¯ã‚¿ã‚¤ãƒˆãƒ«)ã‚’ã‚¤ãƒ³ãƒ‡ã‚¯ã‚µã«ã‚ˆã‚Šã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã«ç™»éŒ²ã—ã¾ã™ã€‚

README.mdã®ã€ŒSetupã€ã®ç« ã«æ›¸ã‹ã‚ŒãŸæ‰‹é †ã«ã‚ˆã‚Šã€Dockerã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä½œæˆã‚„DBã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç­‰ã¯çµ‚ãˆã¦ã„ã‚‹æƒ³å®šã§ã€`api`ã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```
# go run ./cmd/seeds/ja/seed.go
```

ä¸Šæ‰‹ãæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã¸ã®ç™»éŒ²ãŒã§ããŸå ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚

```
# go run ./cmd/seeds/ja/seed.go 
2022/07/23 19:50:57 start indexing documents
2022/07/23 19:50:57 indexed: ã€ŒçœŸå®Ÿã®æ——å°ã€ã¯ã¤ã­ã«æ­£ã—ã„
2022/07/23 19:50:57 indexed: çŸ³ã“ã‚ã¼ã†ã—
2022/07/23 19:50:57 indexed: ãƒ‰ãƒ©ãˆã‚‚ã‚“ã‚ã’ã‚‹
2022/07/23 19:50:57 indexed: ç©ºã¨ã¶è·ãµã 
2022/07/23 19:50:57 indexed: ãƒ¡ãƒ¢ãƒªãƒ¼ãƒ‡ã‚£ã‚¹ã‚¯
2022/07/23 19:50:57 indexed: å‹•ç‰©æŒ‡ã‚­ãƒ£ãƒƒãƒ—
2022/07/23 19:50:57 indexed: ãƒ‰ãƒ©ãˆã‚‚ã‚“ãŒã‚„ã£ã¦ããŸ
....
```

## 7.2 ãƒ‰ãƒ©ãˆã‚‚ã‚“ã®ã‚³ãƒŸãƒƒã‚¯ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ¤œç´¢ã™ã‚‹

ã•ã¦ã€é•·ã„é“ã®ã‚Šã§ã—ãŸãŒã€ã„ã‚ˆã„ã‚ˆæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã‚’è©¦ã—ã¦ã„ãã¾ã™ã€‚

æ—¢ã«è¿°ã¹ãŸé€šã‚Šã€Omochiã¯RESTful APIçµŒç”±ã§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚`/v1/document/search` ã«ä»¥ä¸‹ã®2ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä»˜ä¸ã—ã¦ã€HTTP GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã™ã€‚

- **`"keywords"`**: æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰. æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ãŒè¤‡æ•°ã®å ´åˆã¯`"hoge,fuga,piyo"`ã®ã‚ˆã†ã«","(ã‚«ãƒ³ãƒ)åŒºåˆ‡ã‚Šã§æŒ‡å®šã™ã‚‹
- **`"mode"`(Optional)**: æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰. `"And"` ã‚‚ã—ãã¯ `"Or"` ãŒæŒ‡å®šå¯èƒ½

`curl`ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã‚Šã€æ¤œç´¢æ©Ÿèƒ½ã®å‹•ä½œç¢ºèªã‚’è¡Œã„ã¾ã™ã€‚ã¾ãšã¯ã€`"keywords"="ãƒ‰ãƒ©ãˆã‚‚ã‚“"`,`"mode"=null`ã¨ã—ã¦ã€â€ãƒ‰ãƒ©ãˆã‚‚ã‚“â€ã¨ã„ã†å˜èªãŒå«ã¾ã‚Œã‚‹æ–‡æ›¸ã‚’æ¤œç´¢ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚


```bash
$ curl "http://localhost:8081/v1/document/search?keywords=ãƒ‰ãƒ©ãˆã‚‚ã‚“" | jq .
{
  "documents": [
    {
      "id": 3492,
      "content": "ãƒ‰ãƒ©ãˆã‚‚ã‚“ã®æ­Œ",
      "tokenized_content": [
        "ãƒ‰ãƒ©ãˆã‚‚ã‚“",
        "æ­Œ"
      ],
      "created_at": "2022-07-23T19:56:22+09:00",
      "updated_at": "2022-07-23T19:56:22+09:00"
    },
    {
      "id": 3250,
      "content": "ãƒ‰ãƒ©ãˆã‚‚ã‚“ã ã‚‰ã‘",
      "tokenized_content": [
        "ãƒ‰ãƒ©ãˆã‚‚ã‚“",
        "ã ã‚‰ã‘"
      ],
      "created_at": "2022-07-23T19:56:21+09:00",
      "updated_at": "2022-07-23T19:56:21+09:00"
    },
    {
      "id": 2691,
      "content": "ãƒ‰ãƒ©ãˆã‚‚ã‚“ç™»å ´ï¼",
      "tokenized_content": [
        "ãƒ‰ãƒ©ãˆã‚‚ã‚“",
        "ç™»å ´"
      ],
      "created_at": "2022-07-23T19:56:18+09:00",
      "updated_at": "2022-07-23T19:56:18+09:00"
    },
    ....
```

ã€Œãƒ‰ãƒ©ãˆã‚‚ã‚“ã®æ­Œã€,ã€Œãƒ‰ãƒ©ãˆã‚‚ã‚“ã ã‚‰ã‘ã€...ãªã©ã€"ãƒ‰ãƒ©ãˆã‚‚ã‚“"ã¨ã„ã†å˜èªã‚’å«ã‚€æ–‡æ›¸ã®ã¿ã‚’æ­£ã—ãæ¤œç´¢ã§ãã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

æ¬¡ã«ã€Andæ¤œç´¢ã‚’è©¦ã—ã¦ã¿ã¾ã™ã€‚`"keywords"="ã®ã³å¤ª,ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³"`,`"mode"=And`ã¨ã—ã¦ã€â€ã®ã³å¤ªâ€ã¨â€ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³â€ã¨ã„ã†å˜èªãŒä¸¡æ–¹å«ã¾ã‚Œã‚‹æ–‡æ›¸ã‚’æ¤œç´¢ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
$ curl "http://localhost:8081/v1/document/search?keywords=ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³,ã®ã³å¤ª&mode=And" | jq . 
{
  "documents": [
    {
      "id": 3336,
      "content": "ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³åçœãƒ»ã®ã³å¤ªã¯ã‚ã„ã‚ãã€€",
      "tokenized_content": [
        "ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³",
        "åçœ",
        "ã®ã³å¤ª",
        "ã‚ã„ã‚ã"
      ],
      "created_at": "2022-07-23T19:56:21+09:00",
      "updated_at": "2022-07-23T19:56:21+09:00"
    }
  ]
}
```

æ¤œç´¢çµæœã¨ã—ã¦ã¯ã€ä¸€ã¤ã®ã¿ã§ã™ãŒã€â€ã®ã³å¤ªâ€ã¨â€ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³â€ã®ä¸¡æ–¹ã‚’å«ã‚€æ–‡æ›¸ã‚’æ­£ã—ãæ¤œç´¢ã§ãã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚

æœ€å¾Œã«ã€Oræ¤œç´¢ã§ã™ã€‚`"keywords"="ã®ã³å¤ª,ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³"`(Andã¨åŒã˜),`"mode"=Or`ã¨ã—ã¦ã€â€ã®ã³å¤ªâ€ã‹â€ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³â€ã¨ã„ã†å˜èªã®ã„ãšã‚Œã‹ãŒå«ã¾ã‚Œã‚‹æ–‡æ›¸ã‚’æ¤œç´¢ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
$ curl "http://localhost:8081/v1/document/search?keywords=ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³,ã®ã³å¤ª&mode=Or" | jq . 
{
  "documents": [
    {
      "id": 2707,
      "content": "ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ã‚ˆã„å­ã ã­ã‚“ã­ã—ãª",
      "tokenized_content": [
        "ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³",
        "ã‚ˆã„",
        "å­",
        "ã­ã‚“ã­",
        "ã—ãª"
      ],
      "created_at": "2022-07-23T19:56:18+09:00",
      "updated_at": "2022-07-23T19:56:18+09:00"
    },
    {
      "id": 2720,
      "content": "ã®ã³å¤ªã®ãƒ–ãƒ©ãƒƒã‚¯ãƒ›ãƒ¼ãƒ«",
      "tokenized_content": [
        "ã®ã³å¤ª",
        "ãƒ–ãƒ©ãƒƒã‚¯ãƒ›ãƒ¼ãƒ«"
      ],
      "created_at": "2022-07-23T19:56:18+09:00",
      "updated_at": "2022-07-23T19:56:18+09:00"
    },
    {
      "id": 2729,
      "content": "ã®ã³å¤ªãŒæ¶ˆãˆã¡ã‚ƒã†ï¼Ÿ",
      "tokenized_content": [
        "ã®ã³å¤ª",
        "æ¶ˆãˆ",
        "ã¡ã‚ƒã†"
      ],
      "created_at": "2022-07-23T19:56:18+09:00",
      "updated_at": "2022-07-23T19:56:18+09:00"
    },
    ... 
```

ã€Œã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ã‚ˆã„å­ã ã­ã‚“ã­ã—ãªã€,ã€Œã®ã³å¤ªã®ãƒ–ãƒ©ãƒƒã‚¯ãƒ›ãƒ¼ãƒ«ã€... ãªã©ã€â€ã®ã³å¤ªâ€ã‹â€ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³â€ã®ã„ãšã‚Œã‹ãŒå«ã¾ã‚Œã‚‹æ–‡æ›¸ãŒæ­£ã—ãæ¤œç´¢ã§ãã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

# 8.ã¾ã¨ã‚

é•·ããªã‚Šã¾ã—ãŸãŒã€ä»¥ä¸ŠãŒå®Ÿè£…ã®èª¬æ˜ã«ãªã‚Šã¾ã™ã€‚

ä»Šå›å®Ÿè£…ã—ãŸæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³Omochiã¯ãƒªãƒã‚¸ãƒˆãƒªã«**Just a toy**ã¨æ›¸ã‹ã‚Œã¦ã„ã‚‹é€šã‚Šã€Elasticsearchç­‰ã®æ—¢å­˜ã®ãƒ„ãƒ¼ãƒ«ã‚’æ´»ç”¨ã—ãŸæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã¨æ¯”è¼ƒã™ã‚‹ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚„æ©Ÿèƒ½æ€§ã®é¢ã§å®Ÿç”¨æ€§ã¯ä½ã„ã§ã™ã€‚

ã—ã‹ã—ã€Omochiã‚ˆã†ãªã®æœ€å°é™ã®æ©Ÿèƒ½ã®ã¿ã‚’æŒã¤æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ä½œæ¥­ã¯ã€è»¢ç½®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã¯ã˜ã‚ã¨ã™ã‚‹æƒ…å ±æ¤œç´¢ã®åŸºç¤çŸ¥è­˜ã‚’ç†è§£ã™ã‚‹ä¸Šã§å¤§ããªåŠ©ã‘ã¨ãªã‚Šã¾ã—ãŸã€‚

æœ¬è¨˜äº‹ã‚’èª­ã‚“ã æ–¹ã®ä¸­ã§ã€Omochiã‚’æ°—ã«å…¥ã£ã¦ã‚‚ã‚‰ãˆã‚Œã°ã€[ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/YadaYuki/omochi/)ã«starã‚’ã¤ã‘ã¦ã‚‚ã‚‰ãˆã‚‹ã¨åŠ±ã¿ã«ãªã‚Šã¾ã™ã€‚

# 9.å‚è€ƒæ–‡çŒ®

- [Information Retrieval: Implementing and Evaluating Search Engines](https://www.amazon.co.jp/Information-Retrieval-Implementing-Evaluating-Engines/dp/0262026511)
- [æƒ…å ±æ¤œç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ](https://www.amazon.co.jp/%E6%83%85%E5%A0%B1%E6%A4%9C%E7%B4%A2%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0-%E5%8C%97-%E7%A0%94%E4%BA%8C/dp/4320120361/ref=pd_lpo_3?pd_rd_i=4320120361&psc=1)
- [Pythonã§ã¯ã˜ã‚ã‚‹ æƒ…å ±æ¤œç´¢ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°](https://www.amazon.co.jp/Python%E3%81%A7%E3%81%AF%E3%81%98%E3%82%81%E3%82%8B-%E6%83%85%E5%A0%B1%E6%A4%9C%E7%B4%A2%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0-%E4%BD%90%E8%97%A4-%E9%80%B2%E4%B9%9F/dp/4627818610)
- [WEB+DB PRESS Vol.126. ç‰¹é›† Goã§ä½œã£ã¦å­¦ã¶æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³](https://www.amazon.co.jp/WEB-DB-PRESS-Vol-126-%E7%9C%9F%E5%A3%81/dp/4297125390)
- [æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³è‡ªä½œå…¥é–€ ~æ‰‹ã‚’å‹•ã‹ã—ãªãŒã‚‰è¦‹æ¸¡ã™æ¤œç´¢ã®èˆå°è£](https://www.amazon.co.jp/%E6%A4%9C%E7%B4%A2%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%B3%E8%87%AA%E4%BD%9C%E5%85%A5%E9%96%80-%E6%89%8B%E3%82%92%E5%8B%95%E3%81%8B%E3%81%97%E3%81%AA%E3%81%8C%E3%82%89%E8%A6%8B%E6%B8%A1%E3%81%99%E6%A4%9C%E7%B4%A2%E3%81%AE%E8%88%9E%E5%8F%B0%E8%A3%8F-%E5%B1%B1%E7%94%B0-%E6%B5%A9%E4%B9%8B/dp/4774167533)
