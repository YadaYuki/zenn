---
title: "Nand2tetrisをGoで実装する ~ 中間言語・VM(コンパイラ・バックエンド)編 ~"
emoji: "😺"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Go","nand2tetris","assembly"]
published: true
---

# Nand2tetrisを実装する・目次 
1. [Nand2tetrisを実装する  ~ ハードウェア編(1 ~ 5章) ~](https://zenn.dev/yukiyada/articles/1c5708ddfb36db)
2. [Nand2tetrisをGoで実装する ~ アセンブラ編(6章) ~](https://zenn.dev/yukiyada/articles/44805448111905)
3. **Nand2tetrisをGoで実装する ~ 中間言語・VM(7,8)編 ~**
4. Nand2tetrisをGoで実装する ~ コンパイラ(コンパイラ・フロントエンド)編(10,11章) ~ (執筆中)

# 1.はじめに

**「コンピュータの中では何が起こっているのか？」**
 
近年、ソフトウェア開発を取り巻く技術は急速に発展し、ほとんどの人にとって、コンピュータの内部構造はブラックボックス化しているのではないでしょうか。かくいう私もその一人。コンピュータの内部構造を知らずとも、「技術の使い方」さえ知っていれば、プロダクションレベルのアプリケーションが実装できてしまう時代です。

しかし、仮にもソフトウェアエンジニアを名乗るのであれば、基本的な構造くらいは理解しておきたいもの。そう思った私は、低レイヤーの勉強のために、書籍「コンピュータシステムの理論と実装」が提供するNand2tetrisというプロジェクトに取り組みました。以下は実装したリポジトリです。

https://github.com/YadaYuki/nand2tetris-golang

そして、本記事は「コンピュータシステムの理論と実装」の7,8章に該当する中間言語・Virtual Machine編の実装に関する記事です。

# 2.コンピュータシステムの理論と実装(Nand2tetris)

本章では「コンピュータシステムの理論と実装」という書籍、またその書籍が提供するプロジェクトであるNand2tetrisについて簡単に説明していきます。

https://www.oreilly.co.jp/books/9784873117126/

本書の目的はコンピュータシステムを実際に作り、その作業を通して、コンピュータシステムを深く理解すること。Nand2tetrisというプロジェクト名はNANDゲートを最小素子として、機械語が動作するようなハードウェアを構築し、アセンブラやコンパイラを実装し、最終的にはテトリスが動作するようなコンピュータを構築するという特徴から名付けられています。

そして、ここからは、Nand2tetrisが提供する**Jackというプログラミング言語をアセンブリに変換するコンパイラの実装**に取り組みます。本記事ではその最初のステップとして、中間言語(Intermediate Language,IL)により記述されたプログラムをアセンブリによるプログラムに変換するVM変換器の実装に取り組みます。

# 3.プログラミング言語・Jack

既に述べた通り、本記事から2つの記事にわたって、高級言語によるプログラムを前の記事で説明したHackアセンブリによるプログラムに変換するコンパイラをGoで実装していきます。

その実装について解説していく前に、**コンパイルをする対象である「Jack」というプログラミング言語**を簡単に説明していきます。

「Jack」がどんな言語なのか？を直感的に把握してもらうために、Jackで記述されたプログラムを見ていきましょう。以下は「長さ`length`を持つ配列`a`の各要素に標準入力から値を入力していき、その平均値を出力する」という処理を行うJackプログラムです.

```
class Main {
   function void main() {
     var Array a; 
     var int length;
     var int i, sum;

     let length = Keyboard.readInt("How many numbers? ");
     let a = Array.new(length); 
     
     let i = 0;
     while (i < length) {
        let a[i] = Keyboard.readInt("Enter a number: ");
        let sum = sum + a[i];
        let i = i + 1;
     }
     
     do Output.printString("The average is ");
     do Output.printInt(sum / length);
     return;
   }
}
```

普段私たちが慣れ親しんでいるプログラミング言語とほとんど同じように見えませんか？文法の解説に関しては、次の記事に譲りますが、今回そのコンパイラを実装していく「Jack」というプログラミング言語には以下のような特徴があります。

- オブジェクト指向型言語
- 静的型付け
- コンパイル時、直接実行可能な機械語・アセンブリには変換されず、独自のVirtual Machine上で動作する中間コードに変換される。(like Java,Scala,Kotlin & JVM)

# 4.Jackによるプログラムがアセンブリに変換されるまで.

前章で今回コンパイルする「Jack」というプログラミング言語について簡単に紹介しました。しかし、Jackという「高級言語」で記述されたプログラムをハードウェア上で直接動作させることは、当然できません。高級言語により記述されたプログラムをハードウェア上で実行するためには、プログラムを実行させたいハードウェア・プラットホーム上で動作するような機械語に最終的には変換する必要があります。

それでは、ここで「Jackによるプログラム」が「Nand2tetrisが提供するハードウェア上で動作する16bit機械語」に変換されるまでの全体像を改めて見てみましょう.

![image](https://user-images.githubusercontent.com/57289763/144741977-722b2d98-7595-48a2-af1f-b7b02e296642.png)

Jack言語によるプログラムは「中間言語」「アセンブリ」という二つの形態を経て、最終的に16bit機械語に変換されます。そして本記事で解説するのは**中間言語をHackプラットホーム上で動作するようなアセンブリに変換するVirtual Machine**のGo言語による実装です。

# 5.中間言語に変換することのメリット

# 6. 

# 7.GoによるVirtual Machine(VM変換器)の実装

## 7.1 中間言語がアセンブリに変換されるまで

## 7.2 vmtranslatorパッケージのフォルダ構成

## 7.3 抽象構文木(AST)ノードの定義(ast/ast.go)

## 7.4 構文解析(parser/parser.go)

## 7.5 アセンブリへの変換・構文木評価(codewriter/codewriter.go)

## 7.6 Add.vmを機械語に変換する.

# 8.最後に

# 9.参考文献